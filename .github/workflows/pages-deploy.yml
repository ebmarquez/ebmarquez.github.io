name: "Build and Deploy"
on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - .gitignore
      - README.md
      - LICENSE

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # submodules: true
          # If using the 'assets' git submodule from Chirpy Starter, uncomment above
          # (See: https://github.com/cotes2020/chirpy-starter/tree/main/assets)

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3
          bundler-cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Validate post dates
        run: |
          echo "ğŸ” Checking post timestamps for potential publish issues..."

          # Get current time in UTC
          CURRENT_UTC=$(date -u +%s)

          # Check all posts in _posts directory
          POST_ISSUES=0

          for post in _posts/*.md; do
            if [ ! -f "$post" ]; then
              continue
            fi
            
            # Extract date from frontmatter (looking for "date: YYYY-MM-DD HH:MM:SS -HHMM")
            POST_DATE=$(grep -E '^date:\s*' "$post" | head -1 | sed 's/date:\s*//')
            
            if [ -z "$POST_DATE" ]; then
              echo "âš ï¸  Warning: No date found in $post"
              continue
            fi
            
            # Check if using noon or later PST/PDT (12:00:00 or later)
            if echo "$POST_DATE" | grep -qE '(1[2-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]\s+-08'; then
              echo "âš ï¸  Warning: $post uses noon or later timestamp: $POST_DATE"
              echo "   Recommend using 00:00:00 -0800 to avoid Jekyll future post issues"
              POST_ISSUES=$((POST_ISSUES + 1))
            fi
            
            # Parse date and convert to UTC epoch for comparison
            # Extract just YYYY-MM-DD HH:MM:SS -HHMM part
            POST_TIMESTAMP=$(echo "$POST_DATE" | sed -E 's/([0-9]{4}-[0-9]{2}-[0-9]{2}\s+[0-9]{2}:[0-9]{2}:[0-9]{2}\s+-[0-9]{4}).*/\1/')
            
            # Convert to UTC epoch (this is approximate, good enough for checking)
            POST_EPOCH=$(date -d "$POST_TIMESTAMP" +%s 2>/dev/null || echo "0")
            
            if [ "$POST_EPOCH" -gt "$CURRENT_UTC" ]; then
              POST_FILE=$(basename "$post")
              echo "âš ï¸  Warning: $POST_FILE has future timestamp: $POST_DATE"
              echo "   Current UTC: $(date -u '+%Y-%m-%d %H:%M:%S')"
              echo "   This post may not be published by Jekyll (future: false is default)"
              POST_ISSUES=$((POST_ISSUES + 1))
            fi
          done

          if [ $POST_ISSUES -gt 0 ]; then
            echo ""
            echo "âš ï¸  Found $POST_ISSUES post(s) with potential timestamp issues"
            echo "â„¹ï¸  Note: This site has 'future: true' enabled, so posts should still publish"
            echo "â„¹ï¸  Best practice: Use 00:00:00 -0800 for all post dates"
          else
            echo "âœ… All post timestamps look good!"
          fi

      - name: Build JavaScript assets
        run: npm install && npm run build

      - name: Build site
        run: bundle exec jekyll b -d "_site${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: "production"

      - name: Test site
        run: |
          bundle exec htmlproofer _site \
            \-\-disable-external \
            \-\-ignore-urls "/^http:\/\/127.0.0.1/,/^http:\/\/0.0.0.0/,/^http:\/\/localhost/"

      - name: Upload site artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "_site${{ steps.pages.outputs.base_path }}"

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  verify:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Wait for deployment to propagate
        run: |
          echo "â³ Waiting 30 seconds for GitHub Pages to update..."
          sleep 30

      - name: Verify posts in RSS feed
        run: |
          echo "ğŸ” Verifying latest post in RSS feed..."

          FEED_URL="https://ebmarquez.github.io/feed.xml"
          MAX_ATTEMPTS=5
          ATTEMPT=1

          # Get the most recent post only
          LATEST_POST=$(ls -t _posts/*.md | head -1)

          if [ ! -f "$LATEST_POST" ]; then
            echo "âŒ ERROR: No posts found in _posts directory"
            exit 1
          fi

          # Extract title from the latest post
          LATEST_TITLE=$(grep -E '^title:\s*' "$LATEST_POST" | head -1 | sed 's/title:\s*//' | sed 's/^["'\'']//' | sed 's/["'\'']$//')

          if [ -z "$LATEST_TITLE" ]; then
            echo "âŒ ERROR: No title found in $(basename "$LATEST_POST")"
            exit 1
          fi

          echo "ğŸ“ Latest post: $LATEST_TITLE"
          echo "   File: $(basename "$LATEST_POST")"
          echo ""

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Fetch the RSS feed
            FEED_CONTENT=$(curl -sL "$FEED_URL")
            
            if [ -z "$FEED_CONTENT" ]; then
              echo "âŒ ERROR: Failed to fetch feed.xml"
              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo ""
                echo "âŒ FAILED: Could not fetch RSS feed after $MAX_ATTEMPTS attempts"
                exit 1
              fi
              echo "â³ Waiting 30 seconds before retry..."
              sleep 30
              ATTEMPT=$((ATTEMPT + 1))
              continue
            fi
            
            echo "âœ… Successfully fetched feed.xml"
            
            # Check if the latest post title appears in feed
            if echo "$FEED_CONTENT" | grep -q "$LATEST_TITLE"; then
              echo "âœ… Found latest post in RSS feed!"
              echo ""
              echo "ğŸ‰ Success: '$LATEST_TITLE' is published"
              exit 0
            else
              echo "âŒ Latest post NOT found in feed"
              
              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo ""
                echo "âŒ FAILED: After $MAX_ATTEMPTS attempts, latest post is still missing from feed"
                echo "   Post: $LATEST_TITLE"
                echo "   File: $(basename "$LATEST_POST")"
                exit 1
              else
                echo "â³ Waiting 30 seconds before retry..."
                sleep 30
                ATTEMPT=$((ATTEMPT + 1))
              fi
            fi
            echo ""
          done
              if [ -z "$TITLE" ]; then
                echo "âš ï¸  Warning: No title found in $(basename "$post")"
                continue
              fi
              
              # Check if title appears in feed
              if echo "$FEED_CONTENT" | grep -q "$TITLE"; then
                echo "âœ… Found: $TITLE"
              else
                echo "âŒ MISSING: $TITLE (from $(basename "$post"))"
                MISSING_COUNT=$((MISSING_COUNT + 1))
                MISSING_POSTS="$MISSING_POSTS\n  - $TITLE"
              fi
            done
            
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“Š Summary (Attempt $ATTEMPT):"
            echo "   Recent posts checked: $POST_COUNT"
            echo "   Found in feed: $((POST_COUNT - MISSING_COUNT))"
            echo "   Missing from feed: $MISSING_COUNT"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            if [ $MISSING_COUNT -eq 0 ]; then
              echo ""
              echo "ğŸ‰ All recent posts verified in RSS feed!"
              exit 0
            else
              echo ""
              echo "âš ï¸  Missing posts:$(echo -e "$MISSING_POSTS")"
              
              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo ""
                echo "âŒ FAILED: After $MAX_ATTEMPTS attempts, posts are still missing from feed"
                exit 1
              else
                echo ""
                echo "â³ Waiting 30 seconds before retry..."
                sleep 30
                ATTEMPT=$((ATTEMPT + 1))
              fi
            fi
          done
